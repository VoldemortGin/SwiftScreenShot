#!/bin/bash

# Pre-push hook: åœ¨ push å‰è¿è¡Œæµ‹è¯•
# åªåœ¨ push åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œæµ‹è¯•

# è·å–å½“å‰åˆ†æ”¯
current_branch=$(git symbolic-ref --short HEAD)

# è¯»å– push çš„ç›®æ ‡åˆ†æ”¯ä¿¡æ¯
while read local_ref local_sha remote_ref remote_sha
do
    # æå–è¿œç¨‹åˆ†æ”¯åï¼ˆå»æ‰ refs/heads/ å‰ç¼€ï¼‰
    remote_branch=$(echo "$remote_ref" | sed 's/refs\/heads\///')

    # å¦‚æœæ¨é€åˆ° main åˆ†æ”¯ï¼Œè¿è¡Œæµ‹è¯•
    if [ "$remote_branch" = "main" ] || [ "$current_branch" = "main" ]; then
        echo "ğŸ§ª æ£€æµ‹åˆ°æ¨é€åˆ° main åˆ†æ”¯ï¼Œæ­£åœ¨è¿è¡Œæµ‹è¯•..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # è¿è¡Œ swift test
        swift test

        # æ£€æŸ¥æµ‹è¯•ç»“æœ
        if [ $? -ne 0 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼Push å·²è¢«é˜»æ­¢ã€‚"
            echo "ğŸ’¡ è¯·ä¿®å¤æµ‹è¯•åå†å°è¯• pushã€‚"
            exit 1
        fi

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… æµ‹è¯•é€šè¿‡ï¼ç»§ç»­ push..."
    fi
done

exit 0
